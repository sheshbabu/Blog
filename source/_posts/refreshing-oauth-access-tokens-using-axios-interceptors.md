---
title: Refreshing OAuth Access Tokens using Axios Interceptors
date: 2024-08-11 09:03:50
keywords: OAuth, Microsoft Graph, Axios, Interceptors, SSO, Enterprise Software, Authentication, JavaScript, Nodejs
tags:
  - Authentication
  - Microsoft Graph
  - JavaScript
  - Node.js
---

HTTP Clients like [Axios](https://axios-http.com/docs/interceptors), [HTTPX](https://www.python-httpx.org/advanced/event-hooks/), etc, allow you to hook into the HTTP request lifecycle so you can add custom logic before sending a request or after receiving a response. These "hooks" or "interceptors" are useful for things like adding logs, propagating distributed tracing IDs etc. 

Interceptors can also be used to refresh OAuth Access Tokens. Access Tokens are used to authenticate the client application, and are sent in HTTP requests to the resource server. Access Tokens are typically short-lived for better security, and when they expire, new tokens can be generated by the authorization server.

For this post, we'll be working with the [Microsoft Graph](https://learn.microsoft.com/en-us/graph/auth-v2-service) API and using the [client credentials](https://auth0.com/docs/get-started/authentication-and-authorization-flow/client-credentials-flow) flow, but the same logic can be applied for other endpoints as well.

We'll be talking to two servers:
1. **Resource Server:** The endpoints we want to access.
2. **Token Server:** The server which gives us Access Tokens to authenticate with the Resource Server.

Let's start by creating the [API client module](https://www.sheshbabu.com/posts/organizing-http-requests-using-api-module-pattern/) for Microsoft Graph.

```js
// ./ApiClient.js
import axios from "axios";

const TOKEN_URL = "https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token"; // replace 'tenant' before using
const RESOURCE_BASE_URL = "https://graph.microsoft.com/v1.0";

const ApiClient = axios.create({
    baseURL: RESOURCE_BASE_URL
});

ApiClient.interceptors.request.use(injectAccessToken);

async function injectAccessToken(config) {
    return {
        ...config
    };
}

export default ApiClient;
```

We've left the `injectAccessToken` function as a no-op for now. This API client module can be used in other modules to make calls to resource server endpoints. For example, let's call the [get all users endpoint](https://learn.microsoft.com/en-us/graph/auth-v2-service?tabs=http#5-use-the-access-token-to-call-microsoft-graph) in Microsoft Graph:

```js
// ./index.js
import ApiClient from './ApiClient.js';

const response = await ApiClient.get("/users");
console.log(response.data.value);
```

Let's flesh out the `injectAccessToken` function. We want this function to request Access Token and store it somewhere. If the Access Token has not expired, we use it in all the requests to Resource Server. If it has expired, we fetch new token and update the store. For token storage, we can just create a module-level variable called `token` as it would be overkill to use a database.

Here's the high-level flow as code:
```js
// ./ApiClient.js
let token = "";

async function injectAccessToken(config) {
  // Don't use the interceptor for TOKEN_URL
  if (config.url === TOKEN_URL) {
    return config;
  }

  if (hasAccessTokenExpired(token)) {
    token = await acquireAccessToken();
  }

  const headers = config.headers.concat({Authorization: `Bearer ${token}`});

  return {
    ...config,
    headers,
  };
}
```

Microsoft Graph uses [JWT as Access Tokens](https://www.oauth.com/oauth2-servers/access-tokens/self-encoded-access-tokens/), so we can inspect the payload to check token expiry:

```js
// ./ApiClient.js
import { jwtDecode } from 'jwt-decode';

function hasAccessTokenExpired(token) {
  if (token === "") {
    return true;
  }

  const payload = jwtDecode(token);
  return Date.now() >= payload.exp * 1000;
}
```

We can follow the Microsoft Graph [docs for making a token request](https://learn.microsoft.com/en-us/graph/auth-v2-service?tabs=http#token-request):

```js
// ./ApiClient.js
import qs from 'qs';

const CLIENT_ID = "";
const CLIENT_SECRET = "";

async function acquireAccessToken() {
  const config = {
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
  };
  const body = qs.stringify({
    client_id: CLIENT_ID,
    client_secret: CLIENT_SECRET,
    grant_type: "client_credentials",
    scope: "https://graph.microsoft.com/.default",
  });

  const response = await axios.post(TOKEN_URL, body, config);
  return response.data.access_token;
}
```

Putting them all together:

```js
// ./ApiClient.js
import axios from "axios";
import { jwtDecode } from "jwt-decode";
import qs from "qs";

// Store these in environment variables
const TOKEN_URL = "https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token"; // replace 'tenant' before using
const RESOURCE_BASE_URL = "https://graph.microsoft.com/v1.0";
const CLIENT_ID = "";
const CLIENT_SECRET = "";

let token = "";

const ApiClient = axios.create({
  baseURL: RESOURCE_BASE_URL,
});

ApiClient.interceptors.request.use(injectAccessToken);

async function injectAccessToken(config) {
  // Don't use the interceptor for TOKEN_URL
  if (config.url === TOKEN_URL) {
    return config;
  }

  if (hasAccessTokenExpired(token)) {
    token = await acquireAccessToken();
  }

  const headers = config.headers.concat({ Authorization: `Bearer ${token}` });

  return {
    ...config,
    headers,
  };
}

function hasAccessTokenExpired(token) {
  if (token === "") {
    return true;
  }
  
  const payload = jwtDecode(token);
  return Date.now() >= payload.exp * 1000;
}

async function acquireAccessToken() {
  const config = {
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
  };
  const body = qs.stringify({
    client_id: CLIENT_ID,
    client_secret: CLIENT_SECRET,
    grant_type: "client_credentials",
    scope: "https://graph.microsoft.com/.default",
  });

  const response = await axios.post(TOKEN_URL, body, config);
  return response.data.access_token;
}

export default ApiClient;

```